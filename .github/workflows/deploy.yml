name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          cd frontend
          npm install

      - name: Build Project
        run: |
          cd frontend
          npm run build

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "frontend/dist/*,frontend/nginx.conf"
          target: "/home/${{ secrets.EC2_USER }}/app"
          strip_components: 1

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # Install Nginx if not installed
            if ! command -v nginx &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y nginx
            fi

            # Create destination directory
            sudo mkdir -p /var/www/myapp
            
            # Move build files
            # The scp action puts files in /home/user/app/frontend/dist -> we need to handle the path carefully
            # scp strip_components: 1 removes 'frontend/' so we might have 'dist/' and 'nginx.conf' in target
            
            # Let's check what we have. 
            # We copied "frontend/dist/*" and "frontend/nginx.conf"
            # With strip_components: 1, if we target /home/user/app
            # We should get /home/user/app/dist/ and /home/user/app/nginx.conf
            
            # Move static files
            sudo cp -r /home/${{ secrets.EC2_USER }}/app/dist/* /var/www/myapp/
            
            # Setup Nginx
            sudo cp /home/${{ secrets.EC2_USER }}/app/nginx.conf /etc/nginx/sites-available/myapp
            
            # Update Nginx config root path if needed (our config says /usr/share/nginx/html, we should change it to /var/www/myapp)
            # OR we just update the file we wrote locally to point to /var/www/myapp.
            # Let's update the local file first before pushing, it is cleaner. 
            # But for now I will use sed to replace it on the fly or just overwrite.
            
            # Actually, I should have set the root in nginx.conf correctly.
            # I will update nginx.conf in the next step to point to /var/www/myapp.
            
            sudo ln -sf /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
            
            # Remove default if it exists and conflicts (default listens on 80, we listen on 3000, so no conflict on port, but good practice)
            # sudo rm /etc/nginx/sites-enabled/default 
            
            # Test and Restart Nginx
            sudo nginx -t
            sudo systemctl restart nginx
